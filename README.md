# M3U8 ä»£ç†æœåŠ¡å™¨ (Pro)

ä¸€ä¸ªå·¥ä¸šçº§çš„ M3U8 æµåª’ä½“ä»£ç†æœåŠ¡å™¨ï¼Œé›†æˆ AI èµ‹èƒ½çš„å¹¿å‘Šæ£€æµ‹ã€å¤šæºæ•°æ®èåˆã€é«˜æ€§èƒ½ç¼“å­˜ä»¥åŠç°ä»£åŒ–çš„ç®¡ç†é¢æ¿ã€‚

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

M3U8 Proxy Server æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ Node.js æµåª’ä½“ä¸­é—´ä»¶ï¼Œä¸“ä¸ºå¹¿å‘Šè¿‡æ»¤å’Œæµé‡ä¼˜åŒ–è€Œè®¾è®¡ã€‚å®ƒä¸ä»…æ”¯æŒä¼ ç»Ÿçš„æ­£åˆ™åŒ¹é…ï¼Œè¿˜å¼•å…¥äº†åŸºäº **TensorFlow.js** çš„ç¥ç»ç½‘ç»œæ£€æµ‹æ¨¡å‹å’Œ TS å…ƒæ•°æ®æ·±åº¦åˆ†æï¼Œèƒ½æœ‰æ•ˆè¯†åˆ«å¹¶å‰”é™¤æµåª’ä½“ä¸­çš„åŠ¨æ€å¹¿å‘Šå†…å®¹ã€‚

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§

### ğŸ¤– AI èµ‹èƒ½æ£€æµ‹
- **ç¥ç»ç½‘ç»œåˆ†ç±»å™¨**ï¼šåŸºäº TensorFlow.js çš„è‡ªå®šä¹‰æ¨¡å‹ï¼Œé€šè¿‡å­¦ä¹ ç‰‡æ®µç‰¹å¾è¯†åˆ«å¹¿å‘Šã€‚
- **åœ¨çº¿è®­ç»ƒç³»ç»Ÿ**ï¼šå†…ç½®æ¨¡å‹è®­ç»ƒé¡µé¢ï¼Œæ”¯æŒé€šè¿‡å®æ—¶æ•°æ®ä¸æ–­ä¼˜åŒ–æ£€æµ‹å‡†ç¡®ç‡ã€‚
- **å¤šç‰¹å¾è¾“å…¥**ï¼šåˆ†æç‰‡æ®µæ—¶é•¿ã€ç ç‡å˜åŒ–ã€åˆ†è¾¨ç‡å¼‚å¸¸ç­‰ 20+ ä¸ªç»´åº¦ç‰¹å¾ã€‚

### ğŸ§  å¤šæºæ•°æ®èåˆå¼•æ“
- **åŠ æƒè¯„åˆ†ç³»ç»Ÿ**ï¼šç»¼åˆæ­£åˆ™åŒ¹é…ã€ç»“æ„åˆ†æã€TS å¤´æ£€æµ‹å’Œ AI é¢„æµ‹çš„å¤šä¸ªç»´åº¦è¿›è¡Œæ‰“åˆ†ã€‚
- **ç¡¬è§„åˆ™ä¿æŠ¤**ï¼šå¯¹äºé«˜ç½®ä¿¡åº¦çš„æ£€æµ‹ç»“æœå®ç°å¿«é€Ÿå†³ç­–ï¼Œé™ä½å¤„ç†å»¶è¿Ÿã€‚
- **ä¸Šä¸‹æ–‡æ„ŸçŸ¥**ï¼šç»“åˆæ’­æ”¾åˆ—è¡¨çš„å‰åæ–‡å…³è”æ€§ï¼Œç²¾å‡†è¯†åˆ«æ’å…¥å¼å¹¿å‘Šã€‚

### âš¡ å·¥ä¸šçº§ç¼“å­˜ä¸æ€§èƒ½
- **æ™ºèƒ½åŒå±‚ç¼“å­˜**ï¼šå†…å­˜ LRU ç¼“å­˜ + è‡ªåŠ¨æŒä¹…åŒ–å­˜å‚¨ï¼Œæ”¯æŒç§’çº§æ¢å¤ã€‚
- **åŠ¨æ€ TTL ç­–ç•¥**ï¼šæ ¹æ®è®¿é—®é¢‘ç‡å’Œæ–‡ä»¶å¤§å°è‡ªåŠ¨è°ƒæ•´ç¼“å­˜ç”Ÿå‘½å‘¨æœŸã€‚
- **å¼‚æ­¥å¤„ç†æµæ°´çº¿**ï¼šéé˜»å¡å¼ TS æ¢æµ‹ï¼Œç¡®ä¿æ’­æ”¾æµç•…åº¦ä¸å—å½±å“ã€‚

### ğŸ›¡ï¸ å…¨æ–¹ä½çš„å®‰å…¨ä¸ç®¡ç†
- **JWT èº«ä»½è®¤è¯**ï¼šå®‰å…¨çš„ç®¡ç†é¢æ¿è®¿é—®æ§åˆ¶ã€‚
- **å®æ—¶ç›‘æ§é¢æ¿**ï¼šç›´è§‚çš„ä»ªè¡¨æ¿å±•ç¤ºå®æ—¶æµé‡ã€è¿‡æ»¤ç‡å’ŒæœåŠ¡å™¨è´Ÿè½½ã€‚
- **é…ç½®çƒ­æ›´æ–°**ï¼šæ”¯æŒé€šè¿‡ Web UI åŠ¨æ€è°ƒæ•´è¿‡æ»¤å¼ºåº¦å’Œç³»ç»Ÿå‚æ•°ã€‚

## ğŸ›  æŠ€æœ¯æ ˆ

### åç«¯æ ¸å¿ƒ
- **Node.js & Express** - æ ¸å¿ƒè¿è¡Œæ—¶ä¸ Web æ¡†æ¶
- **TensorFlow.js** - æœºå™¨å­¦ä¹ å¼•æ“
- **mpegts.js / ts-demuxer** - TS æµæ·±åº¦è§£æ
- **jsonwebtoken** - å®‰å…¨èº«ä»½éªŒè¯
- **Axios** - é«˜æ€§èƒ½ HTTP è¯·æ±‚

### å‰ç«¯ç®¡ç†é¢æ¿
- **React 18 & TypeScript** - ç°ä»£å‰ç«¯å¼€å‘æ ˆ
- **Vite** - æé€Ÿæ„å»ºå·¥å…·
- **Tailwind CSS** - ç°ä»£åŒ–å“åº”å¼å¸ƒå±€
- **TanStack Query** - å¼ºå¤§çš„å¼‚æ­¥çŠ¶æ€ç®¡ç†
- **HLS.js** - å·¥ä¸šçº§æµåª’ä½“æ’­æ”¾æµ‹è¯•

## ğŸ“¦ ç¯å¢ƒè¦æ±‚

- **Node.js**: >= 16.0.0 (æ¨è v18+)
- **npm**: >= 7.0.0

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å…‹éš†é¡¹ç›®
```bash
git clone https://github.com/levarsi/m3u8-proxy.git
cd m3u8-proxy
```

### 2. å®‰è£…ä¾èµ–
```bash
# å®‰è£…åç«¯ä¾èµ–
npm install

# å®‰è£…å‰ç«¯ä¾èµ–
npm run ui:install
```

### 3. å¯åŠ¨æœåŠ¡

#### å¼€å‘æ¨¡å¼
```bash
# å¯åŠ¨åç«¯æœåŠ¡ï¼ˆå¼€å‘æ¨¡å¼ï¼Œæ”¯æŒçƒ­é‡è½½ï¼‰
npm run dev

# å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨ï¼ˆæ–°ç»ˆç«¯çª—å£ï¼‰
npm run ui:dev
```

#### ç”Ÿäº§æ¨¡å¼
```bash
# æ„å»ºå‰ç«¯èµ„æº
npm run ui:build

# å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨
npm start
```

## âš™ï¸ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡é…ç½®
åˆ›å»º `.env` æ–‡ä»¶æˆ–è®¾ç½®ç¯å¢ƒå˜é‡ï¼š

```bash
# æœåŠ¡å™¨é…ç½®
PORT=3000                          # æœåŠ¡ç«¯å£
HOST=127.0.0.1                    # ç›‘å¬åœ°å€
NODE_ENV=production                # è¿è¡Œç¯å¢ƒ

# å¹¿å‘Šè¿‡æ»¤é…ç½®
AD_FILTER_ENABLED=true             # å¯ç”¨å¹¿å‘Šè¿‡æ»¤
AD_FILTER_LOG_LEVEL=info          # è¿‡æ»¤æ—¥å¿—çº§åˆ«

# ç¼“å­˜é…ç½®
CACHE_ENABLED=true                 # å¯ç”¨ç¼“å­˜
CACHE_TTL=300000                   # ç¼“å­˜æœ‰æ•ˆæœŸï¼ˆæ¯«ç§’ï¼‰
CACHE_MAX_SIZE=100                 # æœ€å¤§ç¼“å­˜æ¡ç›®æ•°

# å®‰å…¨é…ç½®
RATE_LIMIT_ENABLED=true            # å¯ç”¨é€Ÿç‡é™åˆ¶
RATE_LIMIT_WINDOW=60000            # é€Ÿç‡é™åˆ¶çª—å£ï¼ˆæ¯«ç§’ï¼‰
RATE_LIMIT_MAX=100                 # çª—å£å†…æœ€å¤§è¯·æ±‚æ•°

# CORS é…ç½®
CORS_ENABLED=true                  # å¯ç”¨ CORS
CORS_ORIGIN=*                      # å…è®¸çš„æº
```

### è¯¦ç»†é…ç½®æ–‡ä»¶
ç¼–è¾‘ `config.js` è¿›è¡Œè¯¦ç»†é…ç½®ï¼š

### 3. è®¿é—®ä¸ç™»å½•
- **ç®¡ç†åå°**: `http://localhost:3000`
- **é»˜è®¤è´¦å·**: `admin`
- **é»˜è®¤å¯†ç **: `admin`

## âš™ï¸ æ ¸å¿ƒé…ç½® (`config.js`)

```javascript
module.exports = {
  // è®¤è¯é…ç½®
  auth: {
    enabled: true,
    username: 'admin',
    password: 'admin', // ç”Ÿäº§ç¯å¢ƒè¯·åŠ¡å¿…ä¿®æ”¹
    jwtSecret: 'your-secret-key'
  },
  
  // å¹¿å‘Šè¿‡æ»¤æ·±åº¦é…ç½®
  adFilter: {
    enabled: true,
    enableTSDetection: true, // å¯ç”¨ TS æ·±åº¦æ£€æµ‹
    tsDetection: {
      confidenceThreshold: 0.9, // åˆ¤å®šé˜ˆå€¼
      concurrencyLimit: 5      // å¹¶å‘æ£€æµ‹é™åˆ¶
    }
  },
  
  // ç¼“å­˜ç­–ç•¥
  cache: {
    enabled: true,
    ttl: 600000,
    persistence: {
      enabled: true,
      filePath: './data/cache-data.json'
    }
  }
};
```

## ğŸŒ API æ¥å£

### æ ¸å¿ƒä»£ç†æ¥å£
```http
GET /proxy?url={m3u8_url}
```
ä»£ç†å’Œè¿‡æ»¤ M3U8 æ’­æ”¾åˆ—è¡¨

**å‚æ•°**:
- `url` (å¿…éœ€) - ç›®æ ‡ M3U8 æ–‡ä»¶çš„ URL

**å“åº”å¤´**:
- `Content-Type: application/vnd.apple.mpegurl`
- `X-Processed-By: M3U8-Proxy`
- `X-Processing-Time` - å¤„ç†è€—æ—¶
- `X-Segment-Count` - ç‰‡æ®µæ•°é‡

### ç³»ç»Ÿç®¡ç†æ¥å£
```http
GET  /health              # ç³»ç»Ÿå¥åº·æ£€æŸ¥
GET  /cache/stats         # ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
GET  /cache/clear         # æ¸…é™¤ç¼“å­˜
GET  /logs                # è·å–ç³»ç»Ÿæ—¥å¿—
POST /api/settings        # æ›´æ–°ç³»ç»Ÿé…ç½®
```

### å¹¿å‘Šè¿‡æ»¤æ¥å£
```http
GET  /ad-filter/rules           # è·å–è¿‡æ»¤è§„åˆ™
POST /ad-filter/rules          # æ·»åŠ è¿‡æ»¤è§„åˆ™
GET  /ts-detector/stats        # TS æ£€æµ‹ç»Ÿè®¡
POST /ts-detector/config       # æ›´æ–°æ£€æµ‹é…ç½®
```

### æµ‹è¯•æ¥å£
```http
GET /mock-stream.m3u8    # è·å–åŒ…å«å¹¿å‘Šçš„æµ‹è¯•æµ
```

## ğŸ“– ä½¿ç”¨ç¤ºä¾‹

### 1. ä»£ç† M3U8 æµ
```bash
# åŸºç¡€ä»£ç†
curl "http://localhost:3000/proxy?url=https://example.com/stream.m3u8"

# ä½¿ç”¨æµ‹è¯•æµéªŒè¯å¹¿å‘Šè¿‡æ»¤
curl "http://localhost:3000/proxy?url=http://localhost:3000/mock-stream.m3u8"
```

### 2. ç³»ç»ŸçŠ¶æ€æŸ¥è¯¢
```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:3000/health

# ç¼“å­˜çŠ¶æ€
curl http://localhost:3000/cache/stats
```

### 3. å‰ç«¯ç•Œé¢ä½¿ç”¨
1. è®¿é—® http://localhost:3000
2. åœ¨"æµ‹è¯•/æ’­æ”¾"é¡µé¢è¾“å…¥ M3U8 URL
3. æŸ¥çœ‹è¿‡æ»¤ç»“æœå’Œç»Ÿè®¡ä¿¡æ¯
4. ä½¿ç”¨å†…ç½®æ’­æ”¾å™¨æµ‹è¯•æ’­æ”¾æ•ˆæœ

### 4. è‡ªå®šä¹‰å¹¿å‘Šè¿‡æ»¤è§„åˆ™
```javascript
// åœ¨ config.js ä¸­æ·»åŠ è‡ªå®šä¹‰è§„åˆ™
adFilter: {
  customPatterns: [
    /custom_ad_pattern/i,
    /specific_brand/i
  ]
}
```


## ğŸ—ï¸ é¡¹ç›®ç»“æ„

```text
m3u8-proxy/
â”œâ”€â”€ server.js                # ä¸»å…¥å£ï¼Œå¤„ç†è·¯ç”±ä¸è®¤è¯
â”œâ”€â”€ m3u8-processor.js        # æ ¸å¿ƒé€»è¾‘ï¼šè§£æä¸è¿‡æ»¤ M3U8
â”œâ”€â”€ ts-metadata-detector.js  # TS ç‰‡æ®µç‰¹å¾æå–å™¨
â”œâ”€â”€ neural-network-model.js  # AI æ¨¡å‹å®šä¹‰ä¸é¢„æµ‹
â”œâ”€â”€ multi-source-fusion.js   # å¤šç»´åº¦å†³ç­–èåˆå¼•æ“
â”œâ”€â”€ stats-manager.js         # å…¨å±€ç»Ÿè®¡ä¸æŒä¹…åŒ–
â”œâ”€â”€ cache-manager.js         # æ™ºèƒ½ç¼“å­˜ç®¡ç†
â”œâ”€â”€ config.js                # é›†ä¸­åŒ–é…ç½®æ–‡ä»¶
â”œâ”€â”€ data/                    # æŒä¹…åŒ–æ•°æ®å­˜å‚¨ (JSON, æ¨¡å‹)
â”œâ”€â”€ frontend/                # React ç®¡ç†åå°æºç 
â””â”€â”€ test/                    # å®Œæ•´çš„æµ‹è¯•å¥—ä»¶
```

## ğŸ§ª è‡ªåŠ¨åŒ–æµ‹è¯•

é¡¹ç›®åŒ…å«å®Œå–„çš„æµ‹è¯•æµç¨‹ï¼Œç¡®ä¿æ£€æµ‹å¼•æ“çš„å‡†ç¡®æ€§ï¼š
```bash
node test/test-ts-detection.js   # æµ‹è¯• TS å…ƒæ•°æ®æ£€æµ‹é€»è¾‘
node test/test-learning.js       # æµ‹è¯• AI å­¦ä¹ ä¸æ¨¡å‹æ›´æ–°
node test/test-integration.js    # ç³»ç»Ÿé›†æˆå‹åŠ›æµ‹è¯•
```

## ğŸ“Š è·¯çº¿å›¾ (Roadmap)
- [x] åŸºäºç¥ç»ç½‘ç»œçš„å¹¿å‘Šè¯†åˆ« (Alpha)
- [x] å¤šæºæ£€æµ‹æ•°æ®èåˆ
- [x] ç°ä»£åŒ–ç®¡ç†åå°
- [ ] åˆ†å¸ƒå¼ç¼“å­˜æ”¯æŒ (Redis)
- [ ] è§†é¢‘æŒ‡çº¹è¯†åˆ«æŠ€æœ¯
- [ ] å®¹å™¨åŒ–éƒ¨ç½²æ”¯æŒ (Docker)

## ğŸ“„ è®¸å¯è¯
æœ¬é¡¹ç›®åŸºäº [MIT](LICENSE) è®¸å¯è¯å¼€æºã€‚

---
**æç¤º**: æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ ä¸ç ”ç©¶ä½¿ç”¨ï¼Œè¯·åœ¨éµå®ˆå½“åœ°æ³•å¾‹æ³•è§„çš„å‰æä¸‹ä½¿ç”¨ä»£ç†æŠ€æœ¯ã€‚
